# 区域截图故障排除指南

## 🔍 问题诊断

### 1. 检查控制台日志

#### 在目标网页中：
1. 按 F12 打开开发者工具
2. 切换到 Console 标签页
3. 点击扩展图标，选择"选择区域截图"
4. 查看以下日志信息：
   - "开始区域截图，区域信息:"
   - "页面信息:"
   - "Canvas尺寸:"
   - "截图计算:"
   - "截图段 X/Y:"
   - "区域截图完成，准备返回数据"
   - "截图结果:"

#### 在扩展弹出窗口中：
1. 右键点击扩展图标
2. 选择"检查弹出内容"
3. 切换到 Console 标签页
4. 查看以下日志信息：
   - "发送截图请求..."
   - "收到截图响应:"
   - "准备下载文件:"

### 2. 常见问题及解决方案

#### 问题1：没有显示选择器
**症状：** 点击"选择区域截图"后，页面没有变化

**可能原因：**
- Content script 没有正确注入
- CSS 样式没有加载
- JavaScript 错误

**解决方案：**
1. 检查浏览器控制台是否有错误
2. 重新加载扩展
3. 刷新目标网页
4. 确保在支持的网页上使用（不是 chrome:// 页面）

#### 问题2：选择器显示但无法选择区域
**症状：** 显示半透明遮罩，但拖拽无效

**可能原因：**
- 事件监听器没有正确绑定
- CSS 样式冲突

**解决方案：**
1. 检查是否有其他扩展干扰
2. 尝试在简单网页上测试
3. 禁用其他扩展后重试

#### 问题3：选择区域后没有截图
**症状：** 选择区域后点击"截取区域"，但没有下载文件

**可能原因：**
- 截图API调用失败
- 消息传递问题
- 文件下载权限问题

**解决方案：**
1. 检查控制台日志中的错误信息
2. 确认浏览器下载设置
3. 检查扩展权限

#### 问题4：截图文件损坏或空白
**症状：** 下载了文件，但图片是空白或损坏

**可能原因：**
- Canvas 绘制错误
- 滚动位置计算错误
- 图片数据格式问题

**解决方案：**
1. 检查 Canvas 尺寸设置
2. 验证滚动位置计算
3. 确认图片数据格式

### 3. 调试步骤

#### 步骤1：基础测试
1. 使用调试版本测试：
   ```javascript
   // 临时修改 manifest.json 中的 content_scripts
   "js": ["content-debug.js"]
   ```
2. 重新加载扩展
3. 测试基本功能

#### 步骤2：逐步排查
1. **检查选择器显示**
   - 确认 CSS 样式正确加载
   - 验证 DOM 元素创建

2. **检查区域选择**
   - 确认鼠标事件正确绑定
   - 验证选择框计算

3. **检查截图过程**
   - 确认滚动位置计算
   - 验证 Canvas 绘制

4. **检查文件下载**
   - 确认下载权限
   - 验证文件数据

#### 步骤3：日志分析
查看关键日志信息：

```javascript
// 区域信息
console.log('开始区域截图，区域信息:', area);

// 页面信息
console.log('页面信息:', pageInfo);

// 截图计算
console.log('截图计算:', {
  viewportHeight,
  areaHeight,
  totalScreenshots
});

// 截图过程
console.log(`截图段 ${i + 1}/${totalScreenshots}:`, {
  scrollTop,
  sourceY,
  drawY,
  drawHeight,
  area: area
});

// 最终结果
console.log('截图结果:', result);
```

### 4. 测试用例

#### 测试用例1：小区域截图
- 选择 100x100 像素的小区域
- 验证单次截图是否成功

#### 测试用例2：中等区域截图
- 选择 500x300 像素的中等区域
- 验证是否需要分段截图

#### 测试用例3：长区域截图
- 选择 800x1000 像素的长区域
- 验证分段截图和拼接

#### 测试用例4：跨视口区域
- 选择超出视口高度的区域
- 验证滚动和拼接逻辑

### 5. 性能优化建议

1. **减少等待时间**
   - 根据页面复杂度调整等待时间
   - 使用更智能的页面稳定检测

2. **优化内存使用**
   - 及时释放图片对象
   - 避免创建过多 Canvas

3. **提高截图质量**
   - 使用更高的图片质量设置
   - 优化 Canvas 绘制算法

### 6. 联系支持

如果问题仍然存在，请提供以下信息：

1. **错误日志**
   - 浏览器控制台的完整错误信息
   - 扩展弹出窗口的控制台日志

2. **环境信息**
   - Chrome 版本
   - 操作系统版本
   - 目标网页URL

3. **复现步骤**
   - 详细的操作步骤
   - 期望结果和实际结果

4. **测试页面**
   - 使用的测试页面
   - 选择的具体区域 